chrome.runtime.onMessage.addListener((e,i,r)=>{if(e.action==="startExtension")return console.log("popupからのイベントを受信しました"),chrome.tabs.query({active:!0,currentWindow:!0},s=>{s.length>0&&s[0].id!==void 0&&chrome.tabs.sendMessage(s[0].id,{action:"getKindleHighlight"}).then(async o=>{if(o.success=!1){console.log("ハイライトが存在しません"),r({success:!1,message:"ハイライトが存在しません。"});return}console.log("Notionへ保存する処理を実行します。");const t=await c(o,e.apiKey,e.pageUrl);if(t.type==="failure"){console.error(t.message),r({success:!1,message:t.message});return}console.log("Notionへの保存が完了しました。"),r({success:!0,message:t.message})}).catch(o=>{console.error(`エラーが発生しました : ${o}`),r({success:!1,message:`予期せぬエラーが発生しました。${o}`})})}),!0});const c=async(e,i,r)=>{const s="https://api.notion.com/v1",o={Authorization:`Bearer ${i}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"};try{if(!e.bookDetails)return console.error("ハイライトが存在しないため処理を終了します。"),{type:"failure",message:"ハイライトが存在しないため処理を終了します。"};const t=e.bookDetails.map(a=>[{type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:a.highlight}}]}},{type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:a.note}}]}}]),n=await(await fetch(`${s}/pages`,{method:"POST",headers:o,body:JSON.stringify({parent:{type:"page_id",page_id:r},properties:{title:{type:"title",title:[{type:"text",text:{content:e.title}}]}},children:t.flat()})})).json();return n.object==="error"?(console.error(n),{type:"failure",message:"Notionへの保存に失敗しました。"}):{type:"success",message:`Notionの保存に成功しました。
保存した本 : ${e.title}`}}catch(t){return console.error(`例外が発生しました。Notionへの保存に失敗しました : ${t}`),{type:"failure",message:"Notionへの保存に失敗しました。"}}};
